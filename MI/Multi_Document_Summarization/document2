Automatic Classification of Pulmonary Tuberculosis and Sarcoidosis based on Random Forest Yuanli Wu, Hong Wang, Fei Wu Information Department The 309th Hospital of Chinese PLA Beijing, China Abstract—With the accumulation of medical data and rapid development of artificial intelligence, machine learning has entered the medical field, and especially has been widely adopted in disease diagnosis. The essence of disease identification is classification. In this article, we used the medical data of hospitalized patients in our hospital to train random forest classifiers to make disease differentiation between pulmonary tuberculosis and sarcoidosis. Since there were various medical data formats for patients, and these data spreaded in many isolated medical systems, feature selection was difficult for disease classification. We made feature selection automatically only on laboratory result based on some strategies. Using the laboratory result data set, we performed classification with an average AUC of 81% automatically without doctor's intervention. The results of random forest model gave the importance score of each feature, which provided a basis for early diagnosis and optimization of diagnostic processes of pulmonary tuberculosis and sarcoidosis. Keywords-machine learning; random forest; desease classification I. BACKGROUND With AlphaGo's victory over the top Go human players in 2016, the source of its wisdom - machine learning began to show its extraordinary ability in various fields. According to statistics, training a human doctor needs at least eight years, how long will it take to build an AI (Artificial Intelligence) doctor? In fact, AI doctor has already affected our lives. IBM's Watson doctor, which gains knowledge and intelligence from a cognitive computing platform, has landed a plan with Hangzhou CognitiveCare to help physicians deliver personalized and evidence-based cancer treatment options. Along with more and more medical data accumulated in the medical field, machine learning can reveal the value by mining medical data. Cases of machine learning are spreading wildly in disease diagnosis and medical service improvement[1][2]. Pulmonary sarcoidosis is a granulomatous disease which has hilar lymph nodes and unknown cause, and the diagnosis mainly depends on imaging and pathology[3] Pulmonary tuberculosis in clinical, pathological and immune aspects is similar with pulmonary sarcoidosis, making it difficult to distinguish them clinically. At the same time, it is important to classify these two diseases since the treatment method can be very different . Tuberculosis is mainly concentrated in developing countries, and the 309th hospital carries out the majority of domestic treatment of tuberculosis. The database of hospital has accumulated a lot of valuable treatment data about these two diseases. From the perspective of machine learning, the differential diagnosis of sarcoidosis and tuberculosis is a classification problem, which aims to get effective classification from a series of features of the composition of the sample. Chen et al.[4], launched a comparative study of machine learning approaches. They compared SVM(Support Vector Machine), Decision Classification Tree and Naive Bayes in the classifications of Pulmonary Tuberculosis and Sarcoidosis. Kong et al.[5], illustrated a method using Decision Classification Tree for detecting persons with tuberculous pleurisy. However, the amount of study cases is too small and the method depends on too many feature dimensions, which needs to mine from a lot of different systems, making the model hard to be adopted by hospital. On the other hand, medical data of hospital spreads in many data sources without unified data standard, and doctors write medical records with personalized styles. These have brought challenges to extract the features from database to train disease classified models. On the basis of existing research, considering the problems of machine learning in disease classification, this paper proposes a random forest classification model based on laboratory test results, which can realize automatic feature selection without doctor's intervention. In addition, this method has good accuracy, and can be adjusted to solve the problems of identification of other diseases due to the pervasive feature of method. II. METHODS Our research mainly consists of the following three steps: data preprocess, model building and evaluation respectively. The outline of research method is showed in Fig.1. We will give detail description of these methods in following paragraphs. Sponsored by National Science and Technology Support Program (No.2015BAI01B14-17). 2017 10th International Congress on Image and Signal Processing, BioMedical Engineering and Informatics (CISP-BMEI 2017) 978-1-5386-1937-7/17/$31.00 ©2017 IEEE Figure 1. Research method overview A. Data Pre-processing and Feature Selection Diagnosis and treatment information is distributed in multiple information systems such as Hospital Information System(HIS), Laboratory Information System(LIS) and Electronic Medical Record(EMR). The HIS(Hospital Information System) in my hospital uses oracle to cover all business and processes of the hospital, and contains all patients' diagnosis histories. Firstly, we extracted pulmonary tuberculosis and sarcoidosis patient identification and visit tags in the HIS diagnostic records, and the selected patients were hospitalized from 2010 to 2016 with more than 3 treatment days. In these selected patients' data set, the counts of pulmonary tuberculosis and sarcoidosis are 485 and 1990 respectively. TABLE I. shows a sample of diagnosis data set in HIS database, and the patients' ID are handled anonymously. In the columns, DIAGNOSIS_DESC represents the patient's diagnosis. VISIT_ID represents the number of hospitalizations of the patient, DIAGNOSIS_DATE represents the diagnosis time, and TREAT_DAYS represents the number of hospital stays. TABLE I. SAMPLE OF DIAGNOSIS DATA SET IN HIS DATABASE PATIENT _ID VISIT _ID DIAGNOSI S_DESC DIAGNOSIS_ DATE TREAT_ DAYS patient 1 5 pulmonary tuberculosis 2016-8-22 08:51:00 6 patient 2 1 pulmonary tuberculosis 2016-7-13 08:25:59 17 patient 3 1 pulmonary tuberculosis 2016-8-7 08:52:25 8 patient 4 4 pulmonary tuberculosis 2016-7-25 08:45:41 5 patient 5 1 pulmonary tuberculosis 2016-7-26 08:56:00 8 ... ... pulmonary tuberculosis ... ... patient N 6 pulmonary tuberculosis 2016-7-18 08:19:24 5 Then, we made feature selection. For these two diseases, we extracted all the laboratory test items for all patients and ordered the test items in descending order of the count of abnormal result. We took top 20 laboratory test items for these two diseases respectively, and made union computation to get 34 features for classification. Fig.2 showed top 20 features comparison of these 34 features. As the number of pulmonary tuberculosis patients was far more than that of patients with pulmonary sarcoidosis, we plotted this graph with one logarithmic axis using excel. Figure 2. Top 20 features comparison The record data was stored in Oracle database, we developed C# program to select and parse data set, which was stored as CSV (Comma-Separated Values) file. These files will be used in model training and evaluation for our research. TABLE II. was an overview of the data set file, in which TAG was classification variable (0 for pulmonary nodules, 1 for pulmonary tuberculosis), other column names were selected test item names. Data segmentation Collection original data Dimension reduction and feature selection Data cleaning Exploratory Analysis Split data into training and testing data set Clinical data Electronic medical records Health data Data preprocess Train Adjust model and parameters Missing value Specific value Model building Prediction accuracy comparation ROC curve comparation Features ranking Evaluation Iterate Test model, get result metrics TABLE II. AN OVERVIEW OF THE DATA SET RBC deposited (HCT) uric acid (UA) ... lymphocyte (LYM#) TAG patient 1 Low High ... Low 0 patient 2 Low Low ... Low 1 ... ... ... ... ... ... patient N Low Normal ... Low 0 Finally, we deleted those features with too many null values and finally obtained 15 features for model training. The feature distribution was shown in Fig.3 with green color map. Figure 3. Feature distribution B. Building Model using Random forest We used random forest model to build disease classifier for pulmonary tuberculosis and sarcoidosis. Random forest is constructed by some decision trees. The essence of the random forest[6] algorithm is based on decision tree model as the basic classifier, which uses the combination of multiple decision trees to improve the accuracy of the integrated learning model based on bootstrap aggregating algorithm. Compared with other machine learning algorithms, random forest is not sensitive to multiple collinearity, which has a lot of advantages such as high prediction accuracy and no over-fitting, and can handle high-dimensional data set. Creating random forest model has two main steps. The first step is to extract N different bootstrap samples from the raw data, each for creating a decision tree. Then each decision tree randomly uses F features (F is less than the total number of features). The second step is to establish each decision tree based on splitting criterion. We use Gini[6] as our splitting criterion. Our model selects the split with the lowest impurity at every node using the Gini impurity[7], which measures node label distribution. The Gini impurity is given by: ( ) 0 2 1 i c ci x c i n I t = a   = −        (1) The node ID is t, feature vector is X = {x1, x2, ..., xj}, j is the number of children of node t, N is the number of samples, nci is the number of samples with value xi belonging to class c, and ai is the number of samples with value xi at node t. The split index is weighted by the average of Gini measurements on different values of feature X, which is given by: ( ) ( ) 1 , i i i x j a Gini t X I t = N =  (2) C. Feature Importance The random forest can give the importance score of each feature, and evaluate the role of each feature in the classification. The feature importance score was used to evaluate the effect of the feature on the classification outcome. The higher the importance score of the feature, the more ability of the feature to classify the target variable would be. We used Mean Decrease Gini[8] to weight impurity of feature decrease to obtain the importance of all the features. The Gini impurity can be calculated by adding probability of the item with the label to the probability of error that is classified by the item. When the situation in the node falls into single category, it reaches the minimum (zero). For each tree in a forest, Gini impurity calculates decrease of every feature to get average value, then finally we got a ranked feature list for the whole forest. III. RESULTS We performed the disease classification and model evaluation by using Python and its related packages. We used Random Forest (sklearn.ensemble package) to train model and perform disease classification. Then, we used SVC (sklearn.svm package), Naive Bayes (sklearn.naive_bayes package) and Logistic Regression (sklearn.linear_model package) to perform classification and comparison. Besides, Pandas package was used to store and operate feature matrix of total patient records, Matplotlib package was used to display the analysis result, Sklearn .cross_validation package was used to split the train and test data set, and Sklearn.metrics package was used to draw the ROC(Receiver Operating Characteristic) curve of different models and calulate AUC (Area Under Curve) value. In order to accurately evaluate the classification effect of random forest algorithm, the pre-processing data was randomly splited into random train and test subsets. As is shown in Fig. 4, the dark gray boxes denote the target variable. The size of test subsets was 30%. There were two main parameters for random forest model. We set the number of trees in the forest as 100. The nodes of tree were expanded until all leaves were pure or until all leaves contained less than 2 samples. Figure 4. Dataset split for cross validation A. Model Evaluation Based on the same pre-processing data set and data split scheme, we calculated the model accuracy and ROC curves of the random forest model in disease classification, and compared the classification effect with LR(Logistic regression), NB(Naive Bayes) and SVM(Support Vector Machine) model. The prediction accuracy of all models were given by TABLE III. Random Forest model got 85.33% accuracy, which was a little higher than the others. The prediction accuracy had a certain effect in the clinical identification and diagnosis of the two diseases, especially for those inexperienced young doctors. TABLE III. PREDICTION ACCURACY Model Prediction accuracy Logistic regression 0.8452 Naive Bayes 0.8506 Support Vector Classification 0.8223 Random Forest 0.8533 For comparing different classification models, we draw the ROC curves of each model, and calculate the AUC as the rank score of the model. Figure 5. ROC curve comparing LR, NB, SVM and Random Forest The larger of classifier AUC value, the higher the accuracy rate. In ROC space the X axis is FPR (False Positive Rate), and the Y axis is TPR (True Positive Rate). For a specified threshold, the model outputs FPR and TPR, which draw a point in the ROC space. All the points converge into the ROC curve. All the ROC curves are shown in Fig. 5. The ROC curve is a composite indicator of the binary classifier. The AUC of Random Forest model is 0.81, and it is significantly superior to other models in the ROC index. B. Feature Ranking We used Mean Decrease Gini measurement to get the feature importance (Fig. 6). Feature with high importance had strong association with the prediction results. From all 15 features, uric acid(UA) and the classification results had a significant correlation, while the importance of other features showed a long tail distribution characteristics. The rank list of these features had a certain practical significance for clinical diagnosis, while we still needed to do further communication with medical experts in order to get better interpretation of the result. Figure 6. Ranked list of feature importance IV. CONCLUSION Using the laboratory result data set, we made classification based on Random Forest model, and got an average AUC of 0.81 automatically without doctor's intervention. However, we still needed to improve it in the next study from the following aspects: Firstly, the count of features was limited. On one hand, it was caused by the problem of missing value In the data preprocessing, it was found that the data itself has many null values, which meaned that many patients only take part of the laboratory items(features). Therefore, the feature position of these laboratory items was missed. After deleting the feature column which has large number of missing values, the training feature dimension was limited. On the other hand, our study did not take medical record system, examination image system and other systems into considerations, which consisted more information of the patient and this might affect the completeness of the model training data. Secondly, feature discretization schema made feature information somewhat lost. We only took three discrete values (high, low and normal) to construct our data set. In fact, the specific result of a laboratory item was generally a continuous value which had been lost in discretization process. In the further study, the discretization schema still needed to be refined combined with the doctor's advisement. ACKNOWLEDGMENT The authors would like to thank National Science and Technology Support Program for funding our research. The authors would like to thank Information Department in the 309th Hospital of Chinese PLA for providing us with database platform to run the experiments. REFERENCES [1] W. Zhang. "A Comparative Study of Ensemble Learning Approaches in the Classification of Breast Cancer Metastasis". Bioinformatics, Systems Biology and Intelligent Computing, 2009. IJCBS '09. International Joint Conference on. 2009. pp. 242–245. [2] D.H. Mantzaris, G.C. Anastassopoulos, D.K. Lymberopoulos. "Medical disease prediction using Artificial Neural Networks". 8th IEEE International Conference on BioInformatics and BioEngineering, 2008. [3] M.C. Iannuzzi, and J.R. Fontana, "Sarcoidosis: clinical presentation, immunopathogenesis, and therapeutics." Jama 305.4 (2011): 391-399. [4] C. Aixiang, and C. Zhifeng. "ADST ： Approach of Automated Differentiating Sarcoidosis from Tuberculosis Based on Statistical Learning Theory." Computer Science 41.s1(2014):103-109. [5] K. zhongshun, L. Jingming, and G. Mengqiu. "A preliminary study of decision tree in clinical diagnosis of tuberculous pleurisy." Chinese Journal of Antituberculosis, 2016, 38(6):443-449. [6] L. Breiman. "Random forests." Machine learning 45.1 (2001): 5-32. [7] Loh, Y. Wei. "Classification and regression trees." Wiley Interdisciplinary Reviews: Data Mining and Knowledge Discovery 1.1 (2011): 14-23. [8] B. H. Menze, B. M. Kelm, R. Masuch, U. Himmelreich, P. Bachert, W. Petrich, and F. A. Hamprecht. "A comparison of random forest and its Gini importance with standard chemometric methods for the feature selection and classification of spectral data." BMC bioinformatics 10.1 (2009): 213. 
